<!-- üîΩ Cleaned version starts here -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bathroom Token System</title>
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: #dadb93;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .auth-panel {
      display: flex;
      justify-content: space-around;
      padding: 40px;
      background: linear-gradient(135deg,#2da879,#db8d26);
      color: #fff;
      border-radius: 20px 20px 0 0;
    }

    .auth-panel input {
      display: block;
      width: 250px;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: none;
      outline: none;
    }

    .auth-panel button {
      padding: 10px 25px;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      background: #fff;
      color: #db8d26;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    .auth-panel button:hover {
      background: #eee;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      padding: 20px;
      background: #db8d26;
      color: #fff;
      align-items: center;
      font-size: 18px;
    }

    .topbar button {
      padding: 8px 15px;
      border-radius: 8px;
      border: none;
      background: #fff;
      color: #db8d26;
      cursor: pointer;
      font-weight: bold;
    }

    .topbar button:hover {
      background: #eee;
    }
.submit-panel {
  display: none;
  padding: 30px;
  background: #f0f8f7;
  margin: 20px auto;
  max-width: 500px;
  border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  text-align: center;
  transition: transform 0.3s, box-shadow 0.3s;
}

.submit-panel:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 25px rgba(0,0,0,0.3);
}

.submit-panel h3 {
  margin-bottom: 20px;
  color: #db8d26;
  font-size: 24px;
}

.submit-panel input[type="file"],
.submit-panel input[type="text"] {
  display: block;
  width: 80%;
  margin: 15px auto;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid #ccc;
  font-size: 16px;
  outline: none;
  transition: border 0.3s;
}

.submit-panel input[type="file"]:hover,
.submit-panel input[type="text"]:hover {
  border-color: #db8d26;
}

.submit-panel button {
  margin-top: 15px;
  padding: 12px 30px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg,#2da879,#107a57);
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  font-size: 16px;
  transition: background 0.3s, transform 0.2s;
}

.submit-panel button:hover {
  background: linear-gradient(135deg,#107a57,#2da879);
  transform: scale(1.05);
}

    #tokens-display {
      margin: 20px 0;
      font-size: 20px;
      font-weight: bold;
      color: #db8d26;
      text-align: center;
    }

    .submission-card {
      background: #f0f0f0;
      margin: 15px;
      padding: 15px;
      border-radius: 15px;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .submission-card img {
      border-radius: 10px;
      max-width: 200px;
    }

    .submission-card p {
      margin: 5px 0;
    }
.top-left-logo {
  position: absolute;
  top: 0;
  left: 0;
  width: 200px;
  height: 180px;
}

    /* Warning box */
    #warningBox {
  position: fixed;
  bottom: 20px;      /* distance from bottom */
  right: 20px;       /* distance from right */
  background: rgb(231, 116, 116);
  color: white;
  padding: 15px 20px;
  border-radius: 15px;
  font-weight: bold;
  display: none;
  animation: smoothBlink 1s ease-in-out infinite;
  z-index: 1000;
}


@keyframes smoothBlink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}
  </style>
</head>
<body>
<img src="https://ujjainkumbh.com/wp-content/uploads/2023/12/Ujjain-Kumbh-Final-01.png" 
     alt="Logo" 
     class="top-left-logo">

<div class="container">
  <!-- LOGIN / SIGNUP -->
  <div class="auth-panel" id="authPanel">
    <div>
      <h2>Sign Up</h2>
      <input type="text" id="signupUsername" placeholder="Username">
      <input type="password" id="signupPassword" placeholder="Password">
      <button id="signupBtn">Sign Up</button>
    </div>
    <div>
      <h2>Login</h2>
      <input type="text" id="loginUsername" placeholder="Username">
      <input type="password" id="loginPassword" placeholder="Password">
      <button id="loginBtn">Login</button>
      <button onclick="location.href='UI.html'">Home Page</button>
    </div>
    
  </div>

  <!-- MAIN PANEL -->
  <div id="mainPanel" style="display:none;">
    <div class="topbar">
      <div id="currentUser">Hi, User</div>
      <div>
        <button id="showSubmitBtn">Submit Image</button>
        <button id="showCatalogBtn">Reward Catalog</button>
        <button onclick="location.href='UI.html'">LogOut</button>
      </div>
    </div>

    <div id="tokens-display">Tokens: <span id="tokens">0</span></div>

    <!-- Submit Panel -->
    <div class="submit-panel" id="submitPanel">
      <h3>Submit Bathroom Image</h3>
      <input type="file" id="afterImg" accept="image/*"><br>
      <input type="text" id="location" placeholder="Location (optional)">
      <button onclick="compareWithReference()">Submit</button>
    </div>

    <!-- Reward Catalog -->
    <div id="rewardCatalog" style="display:none; padding: 30px; text-align:center;">
      <h2>Reward Catalog</h2>
      <p style="font-size: 18px; color: #107a57; font-weight: bold;">
        Available Tokens: <span id="catalogTokens">0</span>
      </p>
      <div id="catalogItemsContainer" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px;"></div>
    </div>

    <div id="submissions"></div>
  </div>
</div>

<!-- Warning Box -->
<div id="warningBox">‚ö†Ô∏è You are charged for NOT cleaning the bathroom properly </div>

<script>
// ===== Setup Variables =====
let currentUser = null;
let userData = {};

let refImg = new Image();
refImg.src = "https://images.signaturehardware.com/i/signaturehdwr/summer23-powder-room-hero.jpg";
let refLoaded = false;
refImg.crossOrigin = "anonymous";
refImg.onload = () => { refLoaded = true; };

// ===== Login / Signup =====
document.getElementById("signupBtn").addEventListener("click", () => {
  const username = document.getElementById("signupUsername").value.trim();
  const password = document.getElementById("signupPassword").value.trim();
  if(!username || !password){ alert("Enter both fields"); return; }
  if(localStorage.getItem("userData_"+username)){ alert("User exists!"); return; }
  userData = { tokens:0, submissions:[] };
  localStorage.setItem("userData_"+username, JSON.stringify(userData));
  localStorage.setItem("userPass_"+username, password);
  loginUser(username,password);
});

document.getElementById("loginBtn").addEventListener("click", () => {
  const username = document.getElementById("loginUsername").value.trim();
  const password = document.getElementById("loginPassword").value.trim();
  loginUser(username,password);
});

function loginUser(username,password){
  const storedPass = localStorage.getItem("userPass_"+username);
  if(!storedPass || storedPass !== password){ alert("Invalid credentials"); return; }
  currentUser = username;
  userData = JSON.parse(localStorage.getItem("userData_"+username)) || { tokens:0, submissions:[] };
  document.getElementById("currentUser").innerText = "Hi, "+username;
  document.getElementById("tokens").innerText = userData.tokens;
  document.getElementById("catalogTokens").innerText = userData.tokens;
  renderSubmissions();
  document.getElementById("authPanel").style.display="none";
  document.getElementById("mainPanel").style.display="block";
}



document.getElementById("showSubmitBtn").addEventListener("click",()=>{
  document.getElementById("submitPanel").style.display = "block";
  document.getElementById("rewardCatalog").style.display = "none";
});

document.getElementById("showCatalogBtn").addEventListener("click", () => {
  document.getElementById("rewardCatalog").style.display = "block";
  document.getElementById("submitPanel").style.display = "none";
  renderRewardCatalog();
});

function saveUserData(){
  if(currentUser) localStorage.setItem("userData_"+currentUser, JSON.stringify(userData));
}

// ===== Compare Images and Handle Tokens =====
function compareWithReference(){
  if(!currentUser){ alert("Login first"); return; }
  const fileInput = document.getElementById("afterImg");
  const locationInput = document.getElementById("location").value || "N/A";
  if(!fileInput.files[0]){ alert("Upload image"); return; }
  if(!refLoaded){ alert("Reference not loaded"); return; }
  const imageFile = fileInput.files[0];
  const imageURL = URL.createObjectURL(imageFile);
  let afterImg = new Image();
  afterImg.src=imageURL;
  afterImg.crossOrigin="anonymous";
  afterImg.onload = ()=>{
    const similarity = getImprovedImageSimilarity(refImg,afterImg);
    let earnedTokens=0, resultText="";

    if(similarity>=98.5){earnedTokens=10; resultText="‚úÖ Perfect! 10 Tokens";}
    else if(similarity>=95.5){earnedTokens=3; resultText="‚ö†Ô∏è Partial Clean 3 Tokens";}
    else if(similarity<95.5){
      userData.tokens -= 2;
      if(userData.tokens < 0) userData.tokens = 0;
      resultText="‚ùå Not Clean Enough - 2 Tokens Deducted";

      const warning = document.getElementById("warningBox");
      warning.style.display = "block";
      setTimeout(()=>{ warning.style.display = "none"; }, 5000);
    }

    addSubmission(similarity,earnedTokens,imageURL,locationInput,resultText);
  }
}

function addSubmission(similarity,earnedTokens,imageURL,locationInput,resultText){
  const timestamp = new Date().toLocaleString();
  const submission = { similarity: similarity.toFixed(2), tokens: earnedTokens, location: locationInput, time: timestamp, status: resultText, image: imageURL };
  userData.tokens += earnedTokens;
  userData.submissions.unshift(submission);
  saveUserData();
  document.getElementById("tokens").innerText=userData.tokens;
  document.getElementById("catalogTokens").innerText=userData.tokens;
  renderSubmissions();
}

function renderSubmissions(){
  const container = document.getElementById("submissions");
  container.innerHTML = "";
  if(userData.submissions.length === 0) return;
  userData.submissions.forEach(sub => {
    const div = document.createElement("div");
    div.className = "submission-card";
    div.innerHTML = `
      <img src="${sub.image}">
      <div>
        <p><strong>Similarity:</strong> ${sub.similarity}%</p>
        <p><strong>Tokens Earned:</strong> ${sub.tokens}</p>
        <p><strong>Location:</strong> ${sub.location}</p>
        <p><strong>Date & Time:</strong> ${sub.time}</p>
        <p><strong>Status:</strong> ${sub.status}</p>
      </div>
    `;
    container.appendChild(div);
  });
}

// ===== Reward Catalog =====
const rewards = [
  { name: "Free Meal", desc: "Enjoy a complimentary lunch at our cafeteria", cost: 25, img: "https://res.cloudinary.com/hz3gmuqw6/image/upload/c_fill,q_auto,w_750/f_auto/North-Indian-food-phpUPkVj5" },
  { name: "Company T-Shirt", desc: "High-quality MahaKumbh T-shirt", cost: 105, img: "T-Shirt.png" },
  { name: "Coffee or Tea", desc: "Premium Coffee or Tea", cost: 25, img: "https://images.hindustantimes.com/img/2024/07/28/1600x900/ct_1722155306232_1722155321059.jpg" }
];

function renderRewardCatalog() {
  const container = document.getElementById("catalogItemsContainer");
  container.innerHTML = "";
  document.getElementById("catalogTokens").innerText = userData.tokens;

  rewards.forEach(reward => {
    const hasTokens = userData.tokens >= reward.cost;
    const card = document.createElement("div");
    card.style.width = "230px";
    card.style.background = "#f8f8f8";
    card.style.borderRadius = "15px";
    card.style.padding = "15px";
    card.style.boxShadow = "0 4px 8px rgba(0,0,0,0.1)";
    card.style.textAlign = "left";

    card.innerHTML = `
      <img src="${reward.img}" style="width:100%; border-radius:10px;">
      <h3 style="font-size: 16px;">${reward.name}</h3>
      <p>${reward.desc}</p>
      <div style="font-weight: bold; color:#107a57;">${reward.cost} tokens</div>
      <button ${hasTokens ? "" : "disabled"} style="
        margin-top:10px;
        padding:8px 15px;
        border:none;
        border-radius:8px;
        background:${hasTokens ? "#007bff" : "#ccc"};
        color:${hasTokens ? "#fff" : "#333"};
        cursor:${hasTokens ? "pointer" : "not-allowed"};
      ">
        ${hasTokens ? "Redeem Now" : "Insufficient Tokens"}
      </button>
    `;
    container.appendChild(card);
  });
}

// ===== Image Similarity =====
function getImprovedImageSimilarity(img1,img2){
  const width=200,height=200;
  const canvas1=document.createElement('canvas');
  const canvas2=document.createElement('canvas');
  canvas1.width=canvas2.width=width;
  canvas1.height=canvas2.height=height;
  const ctx1=canvas1.getContext('2d');
  const ctx2=canvas2.getContext('2d');
  ctx1.drawImage(img1,0,0,width,height);
  ctx2.drawImage(img2,0,0,width,height);
  const data1=ctx1.getImageData(0,0,width,height).data;
  const data2=ctx2.getImageData(0,0,width,height).data;
  let totalPixels=width*height;
  let similarPixels=0;
  for(let i=0;i<data1.length;i+=4){
    const gray1=0.299*data1[i]+0.587*data1[i+1]+0.114*data1[i+2];
    const gray2=0.299*data2[i]+0.587*data2[i+1]+0.114*data2[i+2];
    if(Math.abs(gray1-gray2)<15) similarPixels++;
  }
  return (similarPixels/totalPixels)*100;
}
</script>
</body>
</html>
